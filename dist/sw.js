"use strict";!function(r){var e="NYC-RR-",n=e+"static-cache-v1",i=e+"dynamic-cache-v1",o=["/","/index.html","/restaurant.html","/css/styles.css","/js/app.js","/js/main.js","/img/image-fallback.svg","/js/intersection-observer.js","/404.html","/offline.html"],c="http://localhost:1337/restaurants",a="http://localhost:1337/reviews";function s(n){r.indexedDB.open("nyc_rr_data",1).onsuccess=function(t){var e=t.target.result;e.transaction(["restaurants"],"readonly").objectStore("restaurants").get(n).onsuccess=function(t){fetch(c+"/"+n+"/?is_favorite="+t.target.result.is_favorite,{method:"PUT"}).then(function(){fetch(c+"/"+n).then(function(t){if(!t.ok)throw Error("Request failed. Returned status of "+t.statusText);return t.json()}).then(function(t){e.transaction(["restaurants"],"readwrite").objectStore("restaurants").put(t)})}).catch(function(t){console.log(t)})}}}function l(i){r.indexedDB.open("nyc_rr_data",1).onsuccess=function(t){var n=t.target.result;n.transaction(["reviews"],"readonly").objectStore("reviews").get(i).onsuccess=function(t){var e=t.target.result;delete e.id,delete e.offline_request,fetch(a,{method:"POST",body:JSON.stringify(e),headers:new Headers({"Content-Type":"application/json"})}).then(function(){fetch("http://localhost:1337/reviews/?restaurant_id="+e.restaurant_id).then(function(t){if(!t.ok)throw Error("Request failed. Returned status of "+t.statusText);return t.json()}).then(function(t){n.transaction(["reviews"],"readwrite").objectStore("reviews").delete(i).onerror=function(t){console.log(t.target.error)},t.forEach(function(t){n.transaction(["reviews"],"readwrite").objectStore("reviews").put(t).onerror=function(t){console.log(t.target.error)}})})}).catch(function(t){console.log(t)})}}}function u(e){r.clients.matchAll().then(function(t){t.forEach(function(t){t.postMessage({action:e})})}).catch(function(t){console.log("[SW] Something failed while sending message to clients, error",t)})}r.addEventListener("install",function(t){t.waitUntil(caches.open(n).then(function(t){return t.addAll(o)}).catch(function(t){console.log("[SW] Installation failed, error:",t)}))}),r.addEventListener("activate",function(t){t.waitUntil(caches.keys().then(function(t){return Promise.all(t.filter(function(t){return t.startsWith(e)&&t!==n&&t!==i}).map(function(t){return caches.delete(t)}))}).then(function(){return r.clients.claim()}).catch(function(t){console.log("[SW] Activation failed, error:",t)}))}),r.addEventListener("fetch",function(n){if(n.request.url.startsWith(r.location.origin))if(-1<n.request.url.indexOf("restaurant.html")){if(-1===n.request.url.search(/id=./))return void n.respondWith(caches.match("/404.html"));n.respondWith(caches.match("/restaurant.html"))}else n.respondWith(caches.match(n.request).then(function(t){return t||caches.open(i).then(function(e){return fetch(n.request).then(function(t){return 404===t.status?caches.match("/404.html"):(e.put(n.request,t.clone()).catch(function(t){console.log("[SW] Dynamic caching failed, error",t,n.request.url)}),t)}).catch(function(t){return console.log("[SW] Fetch request failed, error",t),caches.match("/offline.html")})}).catch(function(t){console.log("[SW] Opening dynamic cache failed, error",t)})}).catch(function(t){console.log("[SW] Something failed while matching a request, error",t)}))}),r.addEventListener("sync",function(t){-1<t.tag.indexOf("favorite-sync-")?t.waitUntil(void s(parseInt(t.tag.slice(14)))):-1<t.tag.indexOf("review-sync-")&&t.waitUntil(void l(t.tag.slice(12)))}),r.addEventListener("message",function(t){"refresh"===t.data.action&&t.waitUntil(r.skipWaiting().then(function(){u("refreshed")}).catch(function(t){console.log("[SW] Something failed while skipping wait, error",t)})),"dismiss"===t.data.action&&t.waitUntil(u("dismissed")),-1<t.data.action.indexOf("favorite-sync-")&&t.waitUntil(void s(parseInt(t.data.action.slice(14)))),-1<t.data.action.indexOf("review-sync-")&&t.waitUntil(void l(t.data.action.slice(12)))})}(self);
//# sourceMappingURL=sw.js.map
